# Kafka

В проекте реализован асинхронный клиент для Kafka.
Конфиг Kafka находится в **config/kafka_config.py**.


## Конфиг

В конфиге задаются поля для установки соединения с Kafka, а также поля, отвечающие за используемые топики и группы для сообщений.

## Прокси-соединение

Для экономии ресурсов клиент реализует отложенное подключение к Kafka, которое осуществляется с помощью прокси-объекта (**brokers/kafka/connection_proxy.py**). Прокси-соединение является разным для отдельных сущностей. Например, для отдельного консюмера используется один объект прокси, а для продюсера - другой объект.
После установки соединения оно сохраняется в переменную класса и далее переиспользуется.
Разрыв соединения с Kafka осуществляется пользователем с помощью метода `disconnect()` конкретного прокси.

## Консюмер

Код консюмера находится в **brokers/kafka/consumer.py**. Консюмер получает одно сообщение за раз, причем при первом получении сообщения устанавливается соединение с Kafka с помощью прокси-соединения.
Для остановки консюмера используется метод `disconnect()`, который остановит консюмер и, соответственно, разорвет соединение с Kafka.

## Продюсер

Код продюсера находится в **brokers/kafka/producer.py**. Продюсер отправляет одно сообщение за раз, причем при первой отправке сообщения устанавливается соединение с Kafka с помощью прокси-соединения. При отправке каждого сообщения оно проверяется на соответствии pydantic-модели, которая передается в инициализатор продюсера.
Для остановки продюсера используется метод `disconnect()`, который остановит продюсер и, соответственно, разорвет соединение с Kafka.


## Конфигурация топиков и групп

Для конфигурации топиков и групп для работы с сообщениями предусмотрен UI для Kafka, который работает в отдельном контейнере.

## DI-контейнер

Для инициализации объектов консюмера или продюсера соблюдается следующая цепочка создания объектов в di-контейнере:

```python
connection = providers.Factory(connection_proxy.AsyncKafkaProducerProxy)
producer = providers.Factory(producer.KafkaProducerAsync, connection)
```

Изначально создается объект прокси-соединения, который затем передается в объект продюсера/консюмера.
Далее продюсер/консюмер может быть использован для отправки/получения сообщений.

## Пример использования

Продюсер:

```python
connection = connection_proxy.AsyncKafkaProducerProxy()
prod = producer.KafkaProducerAsync(connection)

for i in range(10):
    body = {
        "id": i,
        "text": f"Hello {i}"
    }
    message = broker_message_dto.BrokerMessageDTO(
        body=body
    )

    await prod.produce(message)
```

Консюмер:

```python
connection = connection_proxy.AsyncKafkaConsumerProxy()
cons = consumer.KafkaConsumerAsync(connection)

messages = []

while True:
    message = await cons.retrieve()
    messages.append(message)
```
