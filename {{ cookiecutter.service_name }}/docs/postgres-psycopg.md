# Подключение к Postgres через psycopg

Подключение к БД Postgres реализовано через psycopg в синхронном и асинхронном режиме.
Конфиг postgres находится в **config/pg_config.py**.

## Прокси-соединение

Синхронное и асинхронное подключение к бд Postgres реализует интерфейс **ConnectionProxy** из **interfaces/base_proxy.py**. 
Для получения объекта соединения используется метод `connect()`.
После установки соединения оно сохраняется в переменную и далее переиспользуется.
Разрыв соединения с Postgres осуществляется пользователем с помощью метода `disconnect()` конкретного прокси. 
В прокси-объекте используется подсчет количества пользователей одного соединения. 
При достижении количество пользователей нуля, соединение будет разорвано, иначе объект соединения останется подключенным к БД. 
Это позволяет экономно использовать соединение и переиспользовать его разными сущностями.


## Репозиторий
Для работы с базой данных через соединение psycopg используется репозиторий в синхронном и асинхронном исполнении,
который реализует интерфейс **BaseRepository** из **interfaces/base_repository.py**.
В качестве обязательного параметра репозиторий принимает объект прокси-соединения.
Методы репозитория, для совершения операций с базой данных, используют сохраненный в прокси объект соединения psycopg.
Далее работа с объектом соединения сводится к операциям, согласно документации библиотеки psycopg.

## Unit of work

Для обеспечения транзакционности при работе с бд Postgres через psycopg было реализовано 2 UOW - для синхронной и асинхронной реализаций.
UOW реализован в виде контекстного менеджера, который в методе `__exit__()` вызывает `commit()` у объекта соединения 
или `rollback()` при появлении исключения.

## DI-контейнер

Для инициализации объекта UOW и дальнейшей работы  с бд Postgres через psycopg соблюдается следующая цепочка создания объектов в di-контейнере:

```python
conn_proxy = providers.Factory(psycopg_proxy.PsycopgConnectionProxy, pg_config)
sql_creator = providers.Factory(PsycopgRawSQLCreator)
psycopg_repository = providers.Factory(
    psycopg_repository.PsycopgSyncRepository, conn_proxy, sql_creator
)
psycopg_uow = providers.Factory(psycopg_uow.PsycopgSyncUOW, psycopg_repository)
```

Сначала инициализируется прокси-соединение, которое принимает объект настроек.
Как только был получен объект прокси-соединения, инициализируется объект репозитория, 
который является аргументов для инициализатора объекта UOW.

## Пример использования psycopg UOW через DI-контейнер


```python
# some code

@inject
def psycopg_sample(
        uow: PsycopgSyncUOW = Depends(Provide[PsycopgSyncContainer.psycopg_uow]),
):
    with uow as u:
        u.repository.create(...)
        
# some code
```
